{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
    @media print {
        .no-print {
            display: none !important;
        }
        .btn {
            display: none !important;
        }
        .container {
            width: 100% !important;
            max-width: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
    }
</style>

<div class="container py-4" id="dashboard-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Dashboard</h2>
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <select id="currencySelector" class="form-select form-select-sm no-print" style="width: auto;">
                    <option value="USD" selected>USD ($)</option>
                    <option value="EUR">EUR (€)</option>
                    <option value="INR">INR (₹)</option>
                </select>
                <span id="conversionRateDisplay" class="text-muted small no-print"></span>
            </div>
            <div class="no-print">
                <button class="btn btn-outline-primary" onclick="generatePDF()">
                    <i class="bi bi-file-pdf"></i> Download PDF
                </button>
            </div>
        </div>
    </div>

    <h2 class="mb-4">Financial Overview</h2>

    <!-- Categories and Recent Transactions Row -->
    <div class="row g-4 mb-4">
        <!-- Categories Summary -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-4">Categories This Month</h5>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in category_summary %}
                                <tr>
                                    <td>
                                        <span class="badge bg-{{ 'success' if category.total > 0 else 'danger' }}">
                                            {{ category.category }}
                                        </span>
                                    </td>
                                    <td class="text-end {{ 'text-success' if category.total > 0 else 'text-danger' }}">
                                        <span class="currency-symbol">$</span><span data-amount="{{ category.total|abs }}">{{ '{:,.2f}'.format(category.total|abs) }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Recent Transactions</h5>
                        <a href="{{ url_for('view_transactions') }}" class="btn btn-outline-primary btn-sm no-print">View All</a>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {{ transaction.description }}
                                        <span class="badge bg-secondary">{{ transaction.category }}</span>
                                    </td>
                                    <td class="text-end {{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                        <span class="currency-symbol">$</span><span data-amount="{{ transaction.amount|abs }}">{{ '{:,.2f}'.format(transaction.amount|abs) }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-4">Category Distribution</h2>

    <div class="container mt-4">
        <div class="row mb-4">
            <!-- Category Distribution Chart -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Category Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Category Statistics -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Category Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="categoryStats">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-4">Overview By Daily, Weekly, Monthly, Yearly</h2>

    <div class="container mt-4">
        <div class="row">
            <!-- Daily Chart -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Daily Overview</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px; position: relative;">
                            <canvas id="dailyChart"></canvas>
                        </div>
                        <!-- Daily Transactions List -->
                        <div class="mt-4">
                            <h6 class="mb-3">Daily Transactions</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in daily_transactions %}
                                        <tr>
                                            <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                            <td>{{ transaction.description }}</td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                                    {{ transaction.category }}
                                                </span>
                                            </td>
                                            <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                                {{ '+' if transaction.amount > 0 else '-' }}<span class="currency-symbol">$</span><span data-amount="{{ transaction.amount|abs }}">{{ "%.2f"|format(transaction.amount|abs) }}</span>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center">No transactions found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weekly and Monthly Charts Row -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Weekly Overview</h5>
                            <a href="{{ url_for('view_transactions', filter='weekly') }}" class="btn btn-sm btn-outline-primary no-print">View All</a>
                        </div>
                        <div style="height: 300px; position: relative;">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                        <!-- Weekly Transactions List -->
                        <div class="mt-4">
                            <h6 class="mb-3">Weekly Transactions</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in weekly_transactions %}
                                        <tr>
                                            <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                            <td>{{ transaction.description }}</td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                                    {{ transaction.category }}
                                                </span>
                                            </td>
                                            <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                                {{ '+' if transaction.amount > 0 else '-' }}<span class="currency-symbol">$</span><span data-amount="{{ transaction.amount|abs }}">{{ "%.2f"|format(transaction.amount|abs) }}</span>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center">No transactions found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly and Yearly Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Monthly Chart -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Monthly Overview</h5>
                        <a href="{{ url_for('view_transactions', filter='monthly') }}" class="btn btn-sm btn-outline-primary no-print">View All</a>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    <!-- Monthly Transactions List -->
                    <div class="mt-4">
                        <h6 class="mb-3">Monthly Transactions</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in monthly_transactions %}
                                    <tr>
                                        <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ transaction.description }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                                {{ transaction.category }}
                                            </span>
                                        </td>
                                        <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                            {{ '+' if transaction.amount > 0 else '-' }}<span class="currency-symbol">$</span><span data-amount="{{ transaction.amount|abs }}">{{ "%.2f"|format(transaction.amount|abs) }}</span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No transactions found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yearly Chart -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Yearly Overview</h5>
                        <a href="{{ url_for('view_transactions', filter='yearly') }}" class="btn btn-sm btn-outline-primary no-print">View All</a>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                    <!-- Yearly Transactions List -->
                    <div class="mt-4">
                        <h6 class="mb-3">Yearly Transactions</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in yearly_transactions %}
                                    <tr>
                                        <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ transaction.description }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                                {{ transaction.category }}
                                            </span>
                                        </td>
                                        <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                            {{ '+' if transaction.amount > 0 else '-' }}<span class="currency-symbol">$</span><span data-amount="{{ transaction.amount|abs }}">{{ "%.2f"|format(transaction.amount|abs) }}</span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No transactions found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// Currency conversion rates (you might want to fetch these from an API in production)
const conversionRates = {
    USD: 1,
    EUR: 0.92, // 1 USD = 0.92 EUR
    INR: 82.92 // 1 USD = 82.92 INR
};

const currencySymbols = {
    USD: '$',
    EUR: '€',
    INR: '₹'
};

function updateCurrencyDisplay(currency) {
    const symbols = document.querySelectorAll('.currency-symbol');
    const amounts = document.querySelectorAll('[data-amount]');
    const rate = conversionRates[currency];
    const symbol = currencySymbols[currency];

    // Update currency symbols
    symbols.forEach(el => {
        el.textContent = symbol;
    });

    // Update amounts
    amounts.forEach(el => {
        const originalAmount = parseFloat(el.getAttribute('data-amount'));
        const convertedAmount = (originalAmount * rate).toFixed(2);
        const formattedAmount = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(Math.abs(convertedAmount));
        el.textContent = formattedAmount;
    });

    // Update conversion rate display
    const rateDisplay = document.getElementById('conversionRateDisplay');
    if (currency === 'USD') {
        rateDisplay.textContent = '';
    } else {
        rateDisplay.textContent = `1 USD = ${rate} ${currency}`;
    }

    // Save preference to localStorage
    localStorage.setItem('preferredCurrency', currency);
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize currency selector with saved preference
    const savedCurrency = localStorage.getItem('preferredCurrency') || 'USD';
    document.getElementById('currencySelector').value = savedCurrency;
    updateCurrencyDisplay(savedCurrency);

    // Add event listener for currency selection
    document.getElementById('currencySelector').addEventListener('change', function(e) {
        updateCurrencyDisplay(e.target.value);
    });

    // Add data-amount attributes to all amount elements that don't have them yet
    document.querySelectorAll('.text-end:not(:has(th))').forEach(el => {
        if (!el.querySelector('[data-amount]')) {
            const amountText = el.textContent.trim().replace(/[$,]/g, '');
            const amount = parseFloat(amountText);
            if (!isNaN(amount)) {
                const span = document.createElement('span');
                span.setAttribute('data-amount', amount);
                span.textContent = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(Math.abs(amount));
                el.innerHTML = `<span class="currency-symbol">$</span>${span.outerHTML}`;
            }
        }
    });

    // Get daily data
    const dailyData = {{ daily_data|tojson }};
        
    // Prepare data for daily chart
    const dailyLabels = dailyData.map(d => {
        const date = new Date(d.date);
        return date.getDate(); // Just show the day of month
    });
    const dailyIncomes = dailyData.map(d => d.income);
    const dailyExpenses = dailyData.map(d => d.expenses);

    // Daily Chart
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels: dailyLabels,
            datasets: [{
                label: 'Income',
                data: dailyIncomes,
                backgroundColor: 'rgba(40, 167, 69, 0.5)',
                borderColor: 'rgb(40, 167, 69)',
                borderWidth: 1
            },
            {
                label: 'Expenses',
                data: dailyExpenses,
                backgroundColor: 'rgba(220, 53, 69, 0.5)',
                borderColor: 'rgb(220, 53, 69)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Day of Month'
                    },
                    stacked: false
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount ($)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            return `Day ${dailyLabels[dataIndex]}`;
                        },
                        label: function(context) {
                            const value = context.raw;
                            return `${context.dataset.label}: $${value.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });

    // Weekly Chart
    const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
    const weeklyData = {
        labels: {{ weekly_data | map(attribute='week') | list | tojson }},
        datasets: [{
            label: 'Income',
            data: {{ weekly_data | map(attribute='income') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
        },
        {
            label: 'Expenses',
            data: {{ weekly_data | map(attribute='expenses') | list | tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.5)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1
        }]
    };
    new Chart(weeklyCtx, {
        type: 'bar',
        data: weeklyData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // Monthly Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyData = {
        labels: {{ monthly_data | map(attribute='month') | list | tojson }},
        datasets: [{
            label: 'Income',
            data: {{ monthly_data | map(attribute='income') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
        },
        {
            label: 'Expenses',
            data: {{ monthly_data | map(attribute='expenses') | list | tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.5)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1
        }]
    };
    new Chart(monthlyCtx, {
        type: 'bar',
        data: monthlyData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // Yearly Chart
    const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
    const yearlyData = {
        labels: {{ yearly_data | map(attribute='year') | list | tojson }},
        datasets: [{
            label: 'Income',
            data: {{ yearly_data | map(attribute='income') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
        },
        {
            label: 'Expenses',
            data: {{ yearly_data | map(attribute='expenses') | list | tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.5)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1
        }]
    };
    new Chart(yearlyCtx, {
        type: 'bar',
        data: yearlyData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // Category Pie Chart setup
    const categoryCtx = document.getElementById('categoryPieChart').getContext('2d');
    const categories = {{ categories|tojson }};
    const categoryAmounts = {{ category_amounts|tojson }};
    
    // Generate colors for categories
    const colors = categories.map(() => {
        const r = Math.floor(Math.random() * 200 + 55);
        const g = Math.floor(Math.random() * 200 + 55);
        const b = Math.floor(Math.random() * 200 + 55);
        return `rgba(${r}, ${g}, ${b}, 0.8)`;
    });

    // Create pie chart
    new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: categories,
            datasets: [{
                data: categoryAmounts,
                backgroundColor: colors,
                borderColor: colors.map(color => color.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.raw;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Populate category statistics
    const categoryStats = document.getElementById('categoryStats');
    const total = categoryAmounts.reduce((a, b) => a + b, 0);
    
    let statsHtml = '';
    categories.forEach((category, index) => {
        const amount = categoryAmounts[index];
        const percentage = ((amount / total) * 100).toFixed(1);
        statsHtml += `
            <tr>
                <td>
                    <span class="badge" style="background-color: ${colors[index]}">
                        ${category}
                    </span>
                </td>
                <td>$${amount.toFixed(2)}</td>
                <td>${percentage}%</td>
            </tr>
        `;
    });

    // Add total row
    statsHtml += `
        <tr class="table-light fw-bold">
            <td>Total</td>
            <td>$${total.toFixed(2)}</td>
            <td>100%</td>
        </tr>
    `;

    categoryStats.innerHTML = statsHtml;
});

function generatePDF() {
    const element = document.getElementById('dashboard-content');
    const today = new Date();
    const dateStr = today.getFullYear() + 
                   String(today.getMonth() + 1).padStart(2, '0') + 
                   String(today.getDate()).padStart(2, '0');
    
    const opt = {
        margin: 0.5,
        filename: `BudgetTracker_${dateStr}.pdf`,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { 
            scale: 2,
            useCORS: true,
            logging: true,
            removeContainer: true
        },
        jsPDF: { 
            unit: 'in',
            orientation: 'portrait'
        }
    };
    
    // Add a class to the body during PDF generation
    document.body.classList.add('generating-pdf');
    
    html2pdf().set(opt).from(element).save().then(() => {
        // Remove the class after PDF generation
        document.body.classList.remove('generating-pdf');
    });
}
</script>
{% endblock %}