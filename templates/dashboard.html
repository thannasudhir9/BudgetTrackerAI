{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block styles %}
<style>
    /* Budget Utilization Styles */
    .gauge-container {
        position: relative;
        height: 200px;
        margin: 0 auto;
        max-width: 300px;
    }

    .card-body.text-center {
        padding: 1.5rem;
    }

    .budget-meter {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }

    .budget-meter:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .budget-meter h6.card-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    .budget-info {
        margin-top: 1.5rem;
    }

    .budget-info p {
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .budget-amount {
        font-weight: 600;
        font-size: 1.1rem;
    }

    #monthlySpent, #quarterlySpent, #yearlySpent {
        color: #dc3545;
    }

    #monthlyBudget, #quarterlyBudget, #yearlyBudget {
        color: #0d6efd;
    }

    #monthlyPercentage, #quarterlyPercentage, #yearlyPercentage {
        font-size: 1.2rem;
        font-weight: 700;
        color: #198754;
    }

    .budget-meter .btn-outline-primary {
        margin-top: 1rem;
        padding: 0.375rem 1rem;
        font-size: 0.875rem;
    }

    .budget-meter .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
    }

    /* Gauge colors */
    .gauge-green {
        color: #198754;
    }

    .gauge-yellow {
        color: #ffc107;
    }

    .gauge-red {
        color: #dc3545;
    }

    .spent-amount {
        color: #dc3545;
        font-weight: bold;
    }
    .budget-amount {
        color: #28a745;
        font-weight: bold;
    }
    .utilization-percentage {
        font-size: 1.2em;
        font-weight: bold;
    }
    .utilization-low {
        color: #28a745;
    }
    .utilization-medium {
        color: #ffc107;
    }
    .utilization-high {
        color: #dc3545;
    }
    .gauge-container {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<style>
    @media print {
        .no-print {
            display: none !important;
        }
        .btn {
            display: none !important;
        }
        .container {
            width: 100% !important;
            max-width: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
    }
</style>
<script src="{{ url_for('static', filename='js/utilizationmetrics.js') }}"></script>
<script src="{{ url_for('static', filename='js/downloadPDF.js') }}"></script>
<div class="container py-4" id="dashboard-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Dashboard</h2>
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <select id="currencySelector" class="form-select form-select-sm no-print" style="width: auto;">
                    <option value="USD" selected>USD ($)</option>
                    <option value="EUR">EUR (€)</option>
                    <option value="INR">INR (₹)</option>
                </select>
                <span id="conversionRateDisplay" class="text-muted small no-print"></span>
            </div>
            <div class="no-print">
                <button class="btn btn-outline-primary" onclick="downloadPageAsPDF()">
                    <i class="bi bi-file-pdf"></i> Download PDF
                </button>
            </div>
        </div>
    </div>

    <h2 class="mb-4">Financial Overview</h2>

    <!-- Financial Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Total Income</h6>
                    <h3 class="card-text text-success mb-0">
                        <span class="currency-symbol">$</span>
                        <span class="amount" data-amount="{{ total_income }}">{{ '{:,.2f}'.format(total_income) }}</span>
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Total Expenses</h6>
                    <h3 class="card-text text-danger mb-0">
                        <span class="currency-symbol">$</span>
                        <span class="amount" data-amount="{{ total_expenses }}">{{ '{:,.2f}'.format(total_expenses) }}</span>
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-3">Net Balance</h6>
                    <h3 class="card-text {{ 'text-success' if net_balance >= 0 else 'text-danger' }} mb-0">
                        <span class="currency-symbol">$</span>
                        <span class="amount" data-amount="{{ net_balance }}">{{ '{:,.2f}'.format(net_balance|abs) }}</span>
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories and Recent Transactions Row -->
    <div class="row g-4 mb-4">
        <!-- Categories Summary -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-4">Category Statistics ({{ current_year }})</h5>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in category_summary %}
                                <tr>
                                    <td>
                                        <span class="badge bg-{{ 'success' if category.total > 0 else 'danger' }}">
                                            {{ category.category }}
                                        </span>
                                    </td>
                                    <td class="text-end {{ 'text-success' if category.total > 0 else 'text-danger' }}">
                                        <span class="currency-symbol">$</span><span data-amount="{{ category.total|abs }}">{{ '{:,.2f}'.format(category.total|abs) }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Recent Transactions</h5>
                        <a href="{{ url_for('view_transactions') }}" class="btn btn-outline-primary btn-sm no-print">View All Transactions</a>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {{ transaction.description }}
                                        <span class="badge bg-secondary">{{ transaction.category }}</span>
                                    </td>
                                    <td class="text-end {{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                        <span class="currency-symbol">$</span><span data-amount="{{ transaction.amount|abs }}">{{ '{:,.2f}'.format(transaction.amount|abs) }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-4">Income And Expense Distribution </h2>

    <div class="container mt-4">
        <div class="row mb-4">
            <!-- Category Distribution Chart -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Income And Expense Distribution Pie Chart</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Category Statistics -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Income And Expense Statistics ({{ current_year }}) </h5>
                            <a href="{{ url_for('category_stats') }}" class="btn btn-outline-primary btn-sm no-print">View All Categories</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="categoryStats">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-4">Overview By Daily, Weekly, Monthly, Yearly</h2>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Daily Chart -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Daily Overview</h5>
                            <div class="d-flex gap-2">
                                <select id="monthSelect" class="form-select form-select-sm" style="width: auto;">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                                <select id="yearSelect" class="form-select form-select-sm" style="width: auto;">
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px; position: relative;">
                            <canvas id="dailyChart"></canvas>
                        </div>
                        <!-- Daily Transactions List -->
                        <div class="mt-4">
                            <h6 class="mb-3">Daily Transactions</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-hover" id="dailyTransactionsTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weekly and Monthly Charts Row -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Weekly Overview</h5>
                            <div class="d-flex gap-2">
                                <select id="weekMonthSelect" class="form-select form-select-sm" style="width: auto;">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                                <select id="weekYearSelect" class="form-select form-select-sm" style="width: auto;">
                                    <!-- Will be populated by JavaScript -->
                                </select>
                                <select id="weekSelect" class="form-select form-select-sm" style="width: auto;">
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div style="height: 300px; position: relative;">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                        <!-- Weekly Transactions List -->
                        <div class="mt-4">
                            <h6 class="mb-3">Weekly Transactions</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-hover" id="weeklyTransactionsTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th class="text-end">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly and Yearly Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Monthly Chart -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Monthly Overview ({{ current_year }})</h5>
                        <div class="d-flex gap-2">
                            <select id="monthlyOverviewYearSelect" class="form-select form-select-sm" style="width: auto;">
                                <!-- Will be populated by JavaScript -->
                            </select>
                            <select id="monthlyOverviewMonthSelect" class="form-select form-select-sm" style="width: auto;">
                                <option value="0">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <a href="{{ url_for('view_transactions', filter='monthly') }}" class="btn btn-sm btn-outline-primary no-print">View All</a>
                    </div>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    <!-- Monthly Transactions List -->
                    <div class="mt-4">
                        <h6 class="mb-3">Monthly Transactions</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyTransactionsList">
                                    <tr>
                                        <td colspan="4" class="text-center">Loading transactions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yearly Chart -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Yearly Overview ({{ current_year }})</h5>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                    <!-- Yearly Transactions List -->
                    <div class="mt-4">
                        <h6 class="mb-3">Yearly Transactions</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in yearly_transactions %}
                                    <tr>
                                        <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ transaction.description }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                                {{ transaction.category }}
                                            </span>
                                        </td>
                                        <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                            {{ '+' if transaction.amount > 0 else '-' }}<span class="currency-symbol">$</span><span data-amount="{{ transaction.amount|abs }}">{{ "%.2f"|format(transaction.amount|abs) }}</span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No transactions found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<!-- Budget Utilization Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Budget Utilization</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Monthly Budget Meter -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Monthly Budget</h5>
                                <div class="gauge-container">
                                    <canvas id="monthlyGauge"></canvas>
                                </div>
                                <div class="text-center mt-3">
                                    <p>Spent: <span id="monthlySpent" class="spent-amount">$0</span></p>
                                    <p>Budget: <span id="monthlyBudget" class="budget-amount">$0</span></p>
                                    <p>Utilization: <span id="monthlyPercentage" class="utilization-percentage">0%</span></p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editBudget('monthly')">
                                        <i class="bi bi-pencil-square"></i> Edit Budget
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quarterly Budget Meter -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Quarterly Budget</h5>
                                <div class="gauge-container">
                                    <canvas id="quarterlyGauge"></canvas>
                                </div>
                                <div class="text-center mt-3">
                                    <p>Spent: <span id="quarterlySpent" class="spent-amount">$0</span></p>
                                    <p>Budget: <span id="quarterlyBudget" class="budget-amount">$0</span></p>
                                    <p>Utilization: <span id="quarterlyPercentage" class="utilization-percentage">0%</span></p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editBudget('quarterly')">
                                        <i class="bi bi-pencil-square"></i> Edit Budget
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Yearly Budget Meter -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Yearly Budget</h5>
                                <div class="gauge-container">
                                    <canvas id="yearlyGauge"></canvas>
                                </div>
                                <div class="text-center mt-3">
                                    <p>Spent: <span id="yearlySpent" class="spent-amount">$0</span></p>
                                    <p>Budget: <span id="yearlyBudget" class="budget-amount">$0</span></p>
                                    <p>Utilization: <span id="yearlyPercentage" class="utilization-percentage">0%</span></p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editBudget('yearly')">
                                        <i class="bi bi-pencil-square"></i> Edit Budget
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Budget Edit Modal -->
<div class="modal fade" id="budgetEditModal" tabindex="-1" aria-labelledby="budgetEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="budgetEditModalLabel">Edit Budget</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="budgetEditForm">
                    <input type="hidden" id="editBudgetType" name="budgetType">
                    <div class="mb-3">
                        <label for="budgetAmount" class="form-label">Budget Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="budgetAmount" name="budgetAmount" min="0" step="0.01" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveBudget()">Save Budget</button>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// Currency conversion rates (you might want to fetch these from an API in production)
const conversionRates = {
    USD: 1,
    EUR: 0.92, // 1 USD = 0.92 EUR
    INR: 82.92 // 1 USD = 82.92 INR
};

const currencySymbols = {
    USD: '$',
    EUR: '€',
    INR: '₹'
};

function updateCurrencyDisplay(currency) {
    const symbols = document.querySelectorAll('.currency-symbol');
    const amounts = document.querySelectorAll('[data-amount]');
    const rate = conversionRates[currency];
    const symbol = currencySymbols[currency];

    // Update currency symbols
    symbols.forEach(el => {
        el.textContent = symbol;
    });

    // Update amounts
    amounts.forEach(el => {
        const originalAmount = parseFloat(el.getAttribute('data-amount'));
        const convertedAmount = (originalAmount * rate).toFixed(2);
        const formattedAmount = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(Math.abs(convertedAmount));
        el.textContent = formattedAmount;
    });

    // Update conversion rate display
    const rateDisplay = document.getElementById('conversionRateDisplay');
    if (currency === 'USD') {
        rateDisplay.textContent = '';
    } else {
        rateDisplay.textContent = `1 USD = ${rate} ${currency}`;
    }

    // Save preference to localStorage
    localStorage.setItem('preferredCurrency', currency);
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize currency selector with saved preference
    const savedCurrency = localStorage.getItem('preferredCurrency') || 'USD';
    document.getElementById('currencySelector').value = savedCurrency;
    updateCurrencyDisplay(savedCurrency);

    // Add event listener for currency selection
    document.getElementById('currencySelector').addEventListener('change', function(e) {
        updateCurrencyDisplay(e.target.value);
    });

    // Add data-amount attributes to all amount elements that don't have them yet
    document.querySelectorAll('.text-end:not(:has(th))').forEach(el => {
        if (!el.querySelector('[data-amount]')) {
            const amountText = el.textContent.trim().replace(/[$,]/g, '');
            const amount = parseFloat(amountText);
            if (!isNaN(amount)) {
                const span = document.createElement('span');
                span.setAttribute('data-amount', amount);
                span.textContent = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(Math.abs(amount));
                el.innerHTML = `<span class="currency-symbol">$</span>${span.outerHTML}`;
            }
        }
    });

    // Get daily data
    const dailyData = {{ daily_data|tojson }};
        
    // Prepare data for daily chart
    const dailyLabels = dailyData.map(d => {
        const date = new Date(d.date);
        return date.getDate(); // Just show the day of month
    });
    const dailyIncomes = dailyData.map(d => d.income);
    const dailyExpenses = dailyData.map(d => d.expenses);

    // Daily Chart
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels: dailyLabels,
            datasets: [{
                label: 'Income',
                data: dailyIncomes,
                backgroundColor: 'rgba(40, 167, 69, 0.5)',
                borderColor: 'rgb(40, 167, 69)',
                borderWidth: 1
            },
            {
                label: 'Expenses',
                data: dailyExpenses,
                backgroundColor: 'rgba(220, 53, 69, 0.5)',
                borderColor: 'rgb(220, 53, 69)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Day of Month'
                    },
                    stacked: false
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount ($)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            return `Day ${dailyLabels[dataIndex]}`;
                        },
                        label: function(context) {
                            const value = context.raw;
                            return `${context.dataset.label}: $${value.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });

    // Initialize year select options
    const yearSelect = document.getElementById('yearSelect');
    const currentYearSel = new Date().getFullYear();
    for (let year = currentYearSel; year >= currentYearSel - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }

    // Set current month and year in selects
    const currentMonth = new Date().getMonth() + 1; // JavaScript months are 0-based
    document.getElementById('monthSelect').value = currentMonth;
    document.getElementById('yearSelect').value = currentYearSel;

    // Function to fetch and update daily data
    async function updateDailyChart(month, year) {
        try {
            const response = await fetch(`/api/daily-data/${year}/${month}`);
            if (!response.ok) throw new Error('Failed to fetch data');
            const dailyData = await response.json();

            // Update chart
            const dailyChart = Chart.getChart('dailyChart');
            if (dailyChart) {
                dailyChart.data.labels = dailyData.map(d => new Date(d.date).getDate());
                dailyChart.data.datasets[0].data = dailyData.map(d => d.income);
                dailyChart.data.datasets[1].data = dailyData.map(d => d.expenses);
                dailyChart.update();
            }
        } catch (error) {
            console.error('Error fetching daily data:', error);
        }
    }

    // Function to update daily transactions table
    async function updateDailyTransactions(month, year) {
        try {
            const response = await fetch(`/api/daily-transactions/${year}/${month}`);
            if (!response.ok) throw new Error('Failed to fetch transactions');
            const transactions = await response.json();

            const tbody = document.getElementById('dailyTransactionsTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; // Clear existing rows

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = transaction.amount < 0 ? 'table-danger' : 'table-success';
                
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td>${transaction.description}</td>
                    <td>
                        <span class="badge bg-secondary">${transaction.category}</span>
                    </td>
                    <td class="text-end">${formatCurrency(transaction.amount)}</td>
                `;
                tbody.appendChild(row);
            });

            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">No transactions found</td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error fetching transactions:', error);
        }
    }

    // Add event listeners for month and year selection
    document.getElementById('monthSelect').addEventListener('change', function() {
        const month = this.value;
        const year = document.getElementById('yearSelect').value;
        updateDailyChart(month, year);
        updateDailyTransactions(month, year);
    });

    document.getElementById('yearSelect').addEventListener('change', function() {
        const month = document.getElementById('monthSelect').value;
        const year = this.value;
        updateDailyChart(month, year);
        updateDailyTransactions(month, year);
    });

    // Initial load of transactions
    updateDailyTransactions(currentMonth, currentYearSel);

    // Initialize year select options for both daily and weekly views
    function initYearSelect(selectId) {
        const yearSelect = document.getElementById(selectId);
        const currentYearSel = new Date().getFullYear();
        yearSelect.innerHTML = ''; // Clear existing options
        for (let year = currentYearSel; year >= currentYearSel - 5; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }
        yearSelect.value = currentYearSel;
    }

    // Initialize year selects
    initYearSelect('yearSelect');
    initYearSelect('weekYearSelect');

    // Set current month in selects
    document.getElementById('monthSelect').value = currentMonth;
    document.getElementById('weekMonthSelect').value = currentMonth;

    // Function to get week number of a date
    function getWeekNumber(date) {
        const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
        const firstWeekday = firstDayOfMonth.getDay();
        return Math.ceil((date.getDate() + firstWeekday) / 7);
    }

    // Function to update week options based on selected month and year
    function updateWeekOptions(month, year) {
        const weekSelect = document.getElementById('weekSelect');
        weekSelect.innerHTML = ''; // Clear existing options
        
        const date = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0).getDate();
        const numWeeks = Math.ceil((lastDay + date.getDay()) / 7);
        
        for (let week = 1; week <= numWeeks; week++) {
            const option = document.createElement('option');
            option.value = week;
            option.textContent = `Week ${week}`;
            weekSelect.appendChild(option);
        }
        
        // Set current week if it's current month and year
        const now = new Date();
        if (month === now.getMonth() + 1 && year === now.getFullYear()) {
            weekSelect.value = getWeekNumber(now);
        } else {
            weekSelect.value = 1;
        }
    }

    // Function to fetch and update weekly data
    async function updateWeeklyChart(month, year, week) {
        try {
            const response = await fetch(`/api/weekly-data/${year}/${month}/${week}`);
            if (!response.ok) throw new Error('Failed to fetch data');
            const weeklyData = await response.json();

            // Update chart
            const weeklyChart = Chart.getChart('weeklyChart');
            if (weeklyChart) {
                weeklyChart.data.labels = weeklyData.map(d => d.date);
                weeklyChart.data.datasets[0].data = weeklyData.map(d => d.income);
                weeklyChart.data.datasets[1].data = weeklyData.map(d => d.expenses);
                weeklyChart.update();
            }
        } catch (error) {
            console.error('Error fetching weekly data:', error);
        }
    }

    // Function to update weekly transactions list
    async function updateWeeklyTransactions(year, month, week) {
        try {
            const response = await fetch(`/api/weekly-transactions/${year}/${month}/${week}`);
            if (!response.ok) throw new Error('Failed to fetch transactions');
            const transactions = await response.json();

            const tbody = document.getElementById('weeklyTransactionsTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = ''; // Clear existing rows

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = transaction.amount < 0 ? 'table-danger' : 'table-success';
                
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td>${transaction.description}</td>
                    <td>
                        <span class="badge bg-secondary">${transaction.category}</span>
                    </td>
                    <td class="text-end">${formatCurrency(transaction.amount)}</td>
                `;
                tbody.appendChild(row);
            });

            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">No transactions found</td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error fetching transactions:', error);
        }
    }

    // Add event listeners for weekly view controls
    document.getElementById('weekMonthSelect').addEventListener('change', function() {
        const month = parseInt(this.value);
        const year = parseInt(document.getElementById('weekYearSelect').value);
        updateWeekOptions(month, year);
        const week = parseInt(document.getElementById('weekSelect').value);
        updateWeeklyChart(month, year, week);
        updateWeeklyTransactions(year, month, week);
    });

    document.getElementById('weekYearSelect').addEventListener('change', function() {
        const month = parseInt(document.getElementById('weekMonthSelect').value);
        const year = parseInt(this.value);
        updateWeekOptions(month, year);
        const week = parseInt(document.getElementById('weekSelect').value);
        updateWeeklyChart(month, year, week);
        updateWeeklyTransactions(year, month, week);
    });

    document.getElementById('weekSelect').addEventListener('change', function() {
        const week = parseInt(this.value);
        const month = parseInt(document.getElementById('weekMonthSelect').value);
        const year = parseInt(document.getElementById('weekYearSelect').value);
        updateWeeklyChart(month, year, week);
        updateWeeklyTransactions(year, month, week);
    });

    // Initialize week options for current month and year
    updateWeekOptions(currentMonth, currentYearSel);

    // Weekly Chart
    const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
    const weeklyData = {
        labels: {{ weekly_data | map(attribute='week') | list | tojson }},
        datasets: [{
            label: 'Income',
            data: {{ weekly_data | map(attribute='income') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
        },
        {
            label: 'Expenses',
            data: {{ weekly_data | map(attribute='expenses') | list | tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.5)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1
        }]
    };
    new Chart(weeklyCtx, {
        type: 'bar',
        data: weeklyData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // Function to format currency
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(amount);
    }

    // Function to format date
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }

    // Monthly Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Income',
                data: [],
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgb(40, 167, 69)',
                borderWidth: 1,
                barPercentage: 0.7,
                categoryPercentage: 0.8
            },
            {
                label: 'Expenses',
                data: [],
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: 'rgb(220, 53, 69)',
                borderWidth: 1,
                barPercentage: 0.7,
                categoryPercentage: 0.8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.raw.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Function to update monthly overview
    async function updateMonthlyOverview(year) {
        try {
            const response = await fetch(`/api/monthly-overview/${year}`);
            if (!response.ok) {
                throw new Error('Failed to fetch monthly overview');
            }
            const data = await response.json();

            // Update the monthly chart with new data
            monthlyChart.data.datasets[0].data = data.map(item => item.income);
            monthlyChart.data.datasets[1].data = data.map(item => item.expenses);
            monthlyChart.data.labels = data.map(item => {
                const date = new Date(year, item.month - 1);
                return date.toLocaleString('default', { month: 'short' });
            });
            monthlyChart.update();

            // Update transactions for the current month
            //const currentMonth = new Date().getMonth() + 1;
            updateMonthlyTransactions(year, currentMonth);
        } catch (error) {
            console.error('Error fetching monthly overview:', error);
        }
    }

    // Function to update monthly transactions list
    async function updateMonthlyTransactions(year, month) {
        try {
            const response = await fetch(`/api/monthly-transactions/${year}/${month}`);
            if (!response.ok) {
                throw new Error('Failed to fetch monthly transactions');
            }
            const transactions = await response.json();
            
            const tbody = document.getElementById('monthlyTransactionsList');
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">No transactions found</td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = transactions.map(transaction => `
                <tr>
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.description}</td>
                    <td>
                        <span class="badge bg-${transaction.amount > 0 ? 'success' : 'danger'}">
                            ${transaction.category}
                        </span>
                    </td>
                    <td class="text-end ${transaction.amount > 0 ? 'text-success' : 'text-danger'}">
                        ${transaction.amount > 0 ? '+' : '-'}$${Math.abs(transaction.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error updating monthly transactions:', error);
            document.getElementById('monthlyTransactionsList').innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-danger">Error loading transactions</td>
                </tr>`;
        }
    }

    // Function to update monthly overview and transactions
    function updateOverview() {
        const selectedYear = parseInt(monthlyOverviewYearSelect.value);
        const selectedMonth = parseInt(monthlyOverviewMonthSelect.value);
        updateMonthlyOverview(selectedYear);
        updateMonthlyTransactions(selectedYear, selectedMonth);
        updateUtilizationMeters(selectedYear, selectedMonth);
    }

    // Initialize monthly overview selectors
    const monthlyOverviewYearSelect = document.getElementById('monthlyOverviewYearSelect');
    const monthlyOverviewMonthSelect = document.getElementById('monthlyOverviewMonthSelect');
    const currentYear = new Date().getFullYear();
    //const currentMonth = new Date().getMonth() + 1;
    
    // Populate year options (current year and 4 years back)
    for (let year = currentYear; year >= currentYear - 4; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        monthlyOverviewYearSelect.appendChild(option);
    }

    // Set current month as default
    monthlyOverviewMonthSelect.value = currentMonth;

    // Add event listeners for year and month selection
    monthlyOverviewYearSelect.addEventListener('change', updateOverview);
    monthlyOverviewMonthSelect.addEventListener('change', updateOverview);

    // Initial load
    updateOverview();

    // Update utilization meters when page loads and when month/year changes
    function updateUtilizationMeters(year, month) {
        console.log('year' + year);
        console.log('month' + month);
        fetch(`/api/utilization-metrics/${year}/${month}`)
            .then(response => response.json())
            .then(data => {
                console.log(' data.monthly.spent' +  data.monthly.spent);
                // Update Monthly Meter
                updateMeter('monthly', data.monthly);
                
                // Update Quarterly Meter
                updateMeter('quarterly', data.quarterly); 
                
                // Update Yearly Meter
                updateMeter('yearly', data.yearly);
            })
            .catch(error => console.error('Error fetching utilization metrics:', error));
    }

    function updateMeter(type, data) {
        const spentElement = document.getElementById(`${type}Spent`);
        const budgetElement = document.getElementById(`${type}Budget`);
        const percentageElement = document.getElementById(`${type}Percentage`);
        const percentage = (data.spent / data.budget) * 100;

        // Update text displays
        if (spentElement) spentElement.textContent = formatCurrency(data.spent);
        if (budgetElement) budgetElement.textContent = formatCurrency(data.budget);
        if (percentageElement) percentageElement.textContent = `${percentage.toFixed(1)}%`;

        // Update gauge if it exists
        if (window.gauges && window.gauges[type]) {
            const gauge = window.gauges[type];
            gauge.data.datasets[0].data = [percentage, Math.max(0, 100 - percentage)];
            
            // Update gauge colors based on percentage
            let color;
            if (percentage >= 90) {
                color = 'rgba(220, 53, 69, 0.8)'; // Red
            } else if (percentage >= 75) {
                color = 'rgba(255, 193, 7, 0.8)'; // Yellow
            } else {
                color = 'rgba(40, 167, 69, 0.8)'; // Green
            }
            gauge.data.datasets[0].backgroundColor[0] = color;
            gauge.update();
        }
    }

    function getUtilizationClass(percentage) {
        if (percentage > 90) return 'bg-danger';
        if (percentage > 75) return 'bg-warning';
        return 'bg-success';
    }

    // Add event listeners for utilization meters
    document.getElementById('monthSelect').addEventListener('change', function() {
        const month = this.value;
        const year = document.getElementById('yearSelect').value;
        updateUtilizationMeters(year, month);
    });

    document.getElementById('yearSelect').addEventListener('change', function() {
        const month = document.getElementById('monthSelect').value;
        const year = this.value;
        updateUtilizationMeters(year, month);
    });

    // Initial update of utilization meters
    updateUtilizationMeters(currentYearSel, currentMonth);

    // Yearly Chart
    const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
    const yearlyData = {
        labels: {{ yearly_data | map(attribute='year') | list | tojson }},
        datasets: [{
            label: 'Income',
            data: {{ yearly_data | map(attribute='income') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.8)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1,
            barPercentage: 0.7,
            categoryPercentage: 0.8
        },
        {
            label: 'Expenses',
            data: {{ yearly_data | map(attribute='expenses') | list | tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.8)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1,
            barPercentage: 0.7,
            categoryPercentage: 0.8
        }]
    };
    new Chart(yearlyCtx, {
        type: 'bar',
        data: yearlyData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.raw.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Category Pie Chart setup
    const categoryCtx = document.getElementById('categoryPieChart').getContext('2d');
    const categories = {{ categories|tojson }};
    const categoryAmounts = {{ category_amounts|tojson }};
    const categoryTypes = {{ category_types|tojson }};
    
    // Use green for income and red for expenses
    const colors = [
        '#4CAF50',  // Green
        '#F44336',  // Red
        '#2196F3',  // Blue
        '#FFC107',  // Amber
        '#9C27B0',  // Purple
        '#FF5722',  // Deep Orange
        '#00BCD4',  // Cyan
        '#795548',  // Brown
        '#3F51B5',  // Indigo
        '#E91E63',  // Pink
        '#009688',  // Teal
        '#673AB7'   // Deep Purple
    ];

    // Create pie chart
    new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: categories,
            datasets: [{
                data: categoryAmounts,
                backgroundColor: colors,
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map(function(label, i) {
                                    const meta = chart.getDatasetMeta(0);
                                    const value = data.datasets[0].data[i];
                                    const type = categoryTypes[i];
                                    
                                    return {
                                        text: `${label} (${type === 'income' ? '+' : '-'}$${value.toFixed(2)})`,
                                        fillStyle: colors[i],
                                        strokeStyle: '#ffffff',
                                        lineWidth: 2,
                                        hidden: isNaN(value) || meta.data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const type = categoryTypes[context.dataIndex];
                            return `${context.label}: ${type === 'income' ? '+' : '-'}$${value.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });

    // Populate category statistics
    const categoryStats = document.getElementById('categoryStats');
    const total = categoryAmounts.reduce((a, b) => a + b, 0);
    
    let statsHtml = '';
    categories.forEach((category, index) => {
        const amount = categoryAmounts[index];
        const type = categoryTypes[index];
        const percentage = ((amount / total) * 100).toFixed(1);
        statsHtml += `
            <tr>
                <td>
                    <span class="badge" style="background-color: ${colors[index]}">
                        ${category} (${type})
                    </span>
                </td>
                <td>$${amount.toFixed(2)}</td>
                <td>${percentage}%</td>
            </tr>
        `;
    });

    // Add total row
    statsHtml += `
        <tr class="table-light fw-bold">
            <td>Total</td>
            <td>$${total.toFixed(2)}</td>
            <td>100%</td>
        </tr>
    `;

    categoryStats.innerHTML = statsHtml;

    // Initial load of weekly transactions
    const initialWeek = parseInt(document.getElementById('weekSelect').value);
    const initialMonth = parseInt(document.getElementById('weekMonthSelect').value);
    const initialYear = parseInt(document.getElementById('weekYearSelect').value);
    updateWeeklyTransactions(initialYear, initialMonth, initialWeek);

    // Monthly Overview Year Selection
    //const monthlyOverviewYearSelect = document.getElementById('monthlyOverviewYearSelect');
    //const currentYearSel = new Date().getFullYear();
    
    // Populate year options (current year and 5 years back)
    for (let year = currentYearSel; year >= currentYearSel - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        monthlyOverviewYearSelect.appendChild(option);
    }

    // Function to update monthly overview
    async function updateMonthlyOverview(year) {
        fetch(`/api/monthly-overview/${year}`)
            .then(response => response.json())
            .then(data => {
                // Update the monthly chart with new data
                monthlyChart.data.datasets[0].data = data.map(item => item.income);
                monthlyChart.data.datasets[1].data = data.map(item => item.expenses);
                monthlyChart.data.labels = data.map(item => {
                    const date = new Date(year, item.month - 1);
                    return date.toLocaleString('default', { month: 'short' });
                });
                monthlyChart.update();
            })
            .catch(error => {
                console.error('Error fetching monthly overview:', error);
            });
    }

    // Add event listener for year selection
    monthlyOverviewYearSelect.addEventListener('change', function() {
        updateMonthlyOverview(this.value);
    });

    // Initial load with current year
    const currentYearSelForMonth = new Date().getFullYear();
    updateMonthlyOverview(currentYearSelForMonth);
});


</script>
{% endblock %}