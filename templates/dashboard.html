{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Dashboard</h2>
        <div>
            <button class="btn btn-outline-primary" onclick="downloadAsPDF()">
                <i class="bi bi-file-pdf"></i> Download PDF
            </button>
        </div>
    </div>

    <h2 class="mb-4">Financial Overview</h2>

    <!-- Categories and Recent Transactions Row -->
    <div class="row g-4 mb-4">
        <!-- Categories Summary -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-4">Categories This Month</h5>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in category_summary %}
                                <tr>
                                    <td>
                                        <span class="badge bg-{{ 'success' if category.total > 0 else 'danger' }}">
                                            {{ category.category }}
                                        </span>
                                    </td>
                                    <td class="text-end {{ 'text-success' if category.total > 0 else 'text-danger' }}">
                                        ${{ '{:,.2f}'.format(category.total|abs) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Recent Transactions</h5>
                        <a href="{{ url_for('view_transactions') }}" class="btn btn-outline-primary btn-sm">View All</a>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {{ transaction.description }}
                                        <span class="badge bg-secondary">{{ transaction.category }}</span>
                                    </td>
                                    <td class="text-end {{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                        ${{ '{:,.2f}'.format(transaction.amount|abs) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily and Weekly Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Daily Chart -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Daily Overview</h5>
                    <div style="height: 300px; position: relative;">
                        <canvas id="dailyChart"></canvas>
                    </div>
                    <!-- Daily Transactions List -->
                    <div class="mt-4">
                        <h6 class="mb-3">Daily Transactions</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in daily_transactions %}
                                    <tr>
                                        <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ transaction.description }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                                {{ transaction.category }}
                                            </span>
                                        </td>
                                        <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                            {{ '+' if transaction.amount > 0 else '-' }}${{ "%.2f"|format(transaction.amount|abs) }}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No transactions found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Chart -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Weekly Overview</h5>
                    <div style="height: 300px; position: relative;">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                    <!-- Weekly Transactions List -->
                    <div class="mt-4">
                        <h6 class="mb-3">Weekly Transactions</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in weekly_transactions %}
                                    <tr>
                                        <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ transaction.description }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                                {{ transaction.category }}
                                            </span>
                                        </td>
                                        <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                            {{ '+' if transaction.amount > 0 else '-' }}${{ "%.2f"|format(transaction.amount|abs) }}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No transactions found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly and Yearly Charts Row -->
    <div class="row g-4">
        <!-- Monthly Chart -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Monthly Overview</h5>
                    <div style="height: 300px; position: relative;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    <!-- Monthly Transactions List -->
                    <div class="mt-4">
                        <h6 class="mb-3">Monthly Transactions</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in monthly_transactions %}
                                    <tr>
                                        <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ transaction.description }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                                {{ transaction.category }}
                                            </span>
                                        </td>
                                        <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                            {{ '+' if transaction.amount > 0 else '-' }}${{ "%.2f"|format(transaction.amount|abs) }}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No transactions found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yearly Chart -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Yearly Overview</h5>
                    <div style="height: 300px; position: relative;">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                    <!-- Yearly Transactions List -->
                    <div class="mt-4">
                        <h6 class="mb-3">Yearly Transactions</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in yearly_transactions %}
                                    <tr>
                                        <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ transaction.description }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                                {{ transaction.category }}
                                            </span>
                                        </td>
                                        <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                            {{ '+' if transaction.amount > 0 else '-' }}${{ "%.2f"|format(transaction.amount|abs) }}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No transactions found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Define downloadAsPDF function globally
function downloadAsPDF() {
    window.location.href = '/dashboard/pdf';
}

document.addEventListener('DOMContentLoaded', function() {
    // Chart configuration
    const chartConfig = {
        type: 'bar',
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    };

    // Daily Chart
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    const dailyData = {
        labels: {{ daily_data | map(attribute='date') | list | tojson }},
        datasets: [{
            label: 'Income',
            data: {{ daily_data | map(attribute='income') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
        },
        {
            label: 'Expenses',
            data: {{ daily_data | map(attribute='expenses') | list | tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.5)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1
        }]
    };
    new Chart(dailyCtx, {...chartConfig, data: dailyData});

    // Weekly Chart
    const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
    const weeklyData = {
        labels: {{ weekly_data | map(attribute='week') | list | tojson }},
        datasets: [{
            label: 'Income',
            data: {{ weekly_data | map(attribute='income') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
        },
        {
            label: 'Expenses',
            data: {{ weekly_data | map(attribute='expenses') | list | tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.5)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1
        }]
    };
    new Chart(weeklyCtx, {...chartConfig, data: weeklyData});

    // Monthly Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyData = {
        labels: {{ monthly_data | map(attribute='month') | list | tojson }},
        datasets: [{
            label: 'Income',
            data: {{ monthly_data | map(attribute='income') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
        },
        {
            label: 'Expenses',
            data: {{ monthly_data | map(attribute='expenses') | list | tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.5)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1
        }]
    };
    new Chart(monthlyCtx, {...chartConfig, data: monthlyData});

    // Yearly Chart
    const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
    const yearlyData = {
        labels: {{ yearly_data | map(attribute='year') | list | tojson }},
        datasets: [{
            label: 'Income',
            data: {{ yearly_data | map(attribute='income') | list | tojson }},
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgb(40, 167, 69)',
            borderWidth: 1
        },
        {
            label: 'Expenses',
            data: {{ yearly_data | map(attribute='expenses') | list | tojson }},
            backgroundColor: 'rgba(220, 53, 69, 0.5)',
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 1
        }]
    };
    new Chart(yearlyCtx, {...chartConfig, data: yearlyData});
});
</script>
{% endblock %}